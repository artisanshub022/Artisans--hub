<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARTSIANS HUB - Buyer Dashboard</title>

  <style>
    body {font-family: Arial, sans-serif; background: linear-gradient(135deg,#f6d365,#fda085,#fbc2eb); margin: 0; padding: 20px;}
    .container {max-width: 1000px; margin: auto; background: rgba(255,255,255,0.12); backdrop-filter: blur(8px); border-radius: 20px; padding: 20px;}
    h2 {text-align: center;}
    #artworkList {display: grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap: 14px; margin-top: 20px;}
    .art-card {background: rgba(255,255,255,0.85); padding: 12px; border-radius: 12px; box-shadow: 0 6px 20px rgba(10,10,20,0.06);}
    .art-card img {width: 100%; height: 150px; object-fit: cover; border-radius: 8px;}
    .art-meta {display: flex; justify-content: space-between; margin-top: 6px; font-size: 14px;}
    .btn-primary {background: linear-gradient(90deg,#6a11cb,#2575fc); color: white; border: none; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: bold;}
  </style>
</head>

<body>

  <div class="container">
    <h2>Buyer Dashboard</h2>

    <input type="text" id="searchInput" placeholder="Search artworks..."
      style="width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid rgba(0,0,0,0.1)">

    <div id="artworkList"></div>
  </div>

  <!-- Razorpay checkout script -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://kbekzfrjtruiigbpojmi.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtiZWt6ZnJqdHJ1aWlnYnBvam1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MDExMjksImV4cCI6MjA3NTE3NzEyOX0.P5ZszIMSxsZX80tsG_McKEuamj9aogexfGa9wjkVeGg"
    );

    const artworkList = document.getElementById("artworkList");
    const searchInput = document.getElementById("searchInput");

    let artworksCache = [];

    async function loadArtworks() {
      const { data } = await supabase
        .from("artworks")
        .select("*")
        .order("id", { ascending: false });

      artworksCache = data || [];
      renderList();
    }

    function renderList() {
      const q = searchInput.value.trim().toLowerCase();
      artworkList.innerHTML = "";

      let list = artworksCache.slice();

      if (q) {
        list = list.filter(
          (a) =>
            (a.title || "").toLowerCase().includes(q) ||
            (a.description || "").toLowerCase().includes(q)
        );
      }

      if (list.length === 0) {
        artworkList.innerHTML =
          "<div style='color:#333; text-align:center; margin-top:20px'>No artworks found.</div>";
        return;
      }

      list.forEach((a) => {
        const card = document.createElement("div");
        card.className = "art-card";

        card.innerHTML = `
          <img src="${a.image_url}" />
          <h4>${a.title}</h4>
          <p>${a.description}</p>
          <div class="art-meta">
            <span>₹${a.price}</span>
            <span>${a.customization}</span>
          </div>
          <button class="btn-primary" onclick="onBuy(${a.id})">Buy</button>
        `;

        artworkList.appendChild(card);
      });
    }

    // ✅ Payment flow using Razorpay
    window.onBuy = async (artworkId) => {
      const artwork = artworksCache.find(a => a.id === artworkId);
      if(!artwork) return;

      const options = {
        key: "rzp_test_YourTestKeyHere", // Replace with your Razorpay test/live key
        amount: artwork.price * 100, // Amount in paise
        currency: "INR",
        name: "ARTSIANS HUB",
        description: artwork.title,
        handler: async function (response){
          // Payment success, save order to Supabase
          try {
            await supabase.from("orders").insert([{
              artwork_id: artwork.id,
              artwork_title: artwork.title,
              artist_name: artwork.artist_name,
              price: artwork.price,
              payment_id: response.razorpay_payment_id,
              status: "paid"
            }]);
            alert("Payment successful! Your order is confirmed.");
          } catch (e) {
            console.error(e);
            alert("Payment successful but failed to save order. Contact support.");
          }
        },
        prefill: {
          name: "", // Optional buyer name
          email: "" // Optional buyer email
        },
        theme: { color: "#6a11cb" }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    };

    searchInput.addEventListener("input", renderList);

    loadArtworks();
  </script>

</body>
</html>
